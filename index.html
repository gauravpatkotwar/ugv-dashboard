<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UGV COMMAND CENTER</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.10.1/dist/nipplejs.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#000; color:#fff; font-family:monospace; overflow:hidden; height:100vh; }
    header { background:#111; border-bottom:2px solid #444; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
    .blink { animation:b 1.5s infinite; } @keyframes b { 0%,100%{opacity:1} 50%{opacity:0.3} }
    .grid { display:grid; grid-template-columns:65% 35%; grid-template-rows:58% 42%; gap:12px; padding:12px; height:calc(100vh - 56px); }
    .card { background:#111; border:1px solid #333; border-radius:8px; overflow:hidden; position:relative; }
    .cam { grid-row:1/3; }
    .cam img { width:100%; height:100%; object-fit:cover; }
    .cam::after { content:"60 FPS • LIVE • ARMED"; position:absolute; top:12px; left:12px; background:#000c; padding:6px 14px; border:1px solid #555; font-size:0.9rem; }
    #map { height:100%; border-radius:8px; }
    #joy { width:170px; height:170px; margin:20px auto; }
    .gauge { width:130px; height:130px; margin:10px auto; position:relative; }
    svg { width:100%; height:100%; transform:rotate(-90deg); }
    .bg { stroke:#222; stroke-width:14; fill:none; }
    .fg { stroke:#fff; stroke-width:14; stroke-linecap:round; stroke-dasharray:377; stroke-dashoffset:377; transition:all 1s; }
    .val { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:2.3rem; font-weight:bold; }
  </style>
</head>
<body>
  <header>
    <div>UGV COMMAND CENTER <span class="blink">●</span></div>
    <div>ARMED • GLOBAL LINK ACTIVE</div>
  </header>

  <div class="grid">
    <!-- Live Camera -->
    <div class="card cam">
      <img id="cam" src="/video" alt="Live feed">
    </div>

    <!-- GPS Map -->
    <div class="card">
      <h2 style="padding:10px; border-bottom:1px solid #444;">GPS TRACKING</h2>
      <div id="map"></div>
    </div>

    <!-- Joystick -->
    <div class="card">
      <h2 style="padding:10px; border-bottom:1px solid #444; text-align:center;">DRIVE CONTROL</h2>
      <div id="joy"></div>
    </div>

    <!-- Power & Audio -->
    <div class="card">
      <h2 style="padding:10px; border-bottom:1px solid #444; text-align:center;">POWER & AUDIO</h2>
      <div class="gauge">
        <svg><circle cx="80" cy="80" r="60" class="bg"/><circle cx="80" cy="80" r="60" class="fg" id="batt"/></svg>
        <div class="val" id="bp">--%</div>
      </div>
      <div style="text-align:center; color:#888;">
        <span id="volt">--.-</span>V • MIC <span id="mic">--</span>
      </div>
    </div>
  </div>

  <script>
    const socket = io();

    // Joystick
    const manager = nipplejs.create({
      zone: document.getElementById('joy'),
      mode: 'static',
      position: { left: '50%', top: '50%' },
      color: '#ddd',
      size: 130
    });
    manager.on('move', (evt, data) => {
      if (data.position) {
        const x = (data.position.x - 65) / 65;  // -1 to +1
        const y = -(data.position.y - 65) / 65; // inverted Y
        socket.emit('joy', { x: parseFloat(x.toFixed(2)), y: parseFloat(y.toFixed(2)) });
      }
    });
    manager.on('end', () => socket.emit('joy', { x: 0, y: 0 }));

    // GPS Map
    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const marker = L.marker([20, 0]).addTo(map);

    // Receive real data from Pi
    socket.on('data', d => {
      if (d.lat && d.lon && d.lat !== 'n/a') {
        marker.setLatLng([d.lat, d.lon]);
        map.setView([d.lat, d.lon], 18);
      }
      document.getElementById('bp').textContent = d.batt + '%';
      document.getElementById('volt').textContent = d.volt;
      document.getElementById('mic').textContent = d.mic;
      document.getElementById('batt').style.strokeDashoffset = 377 - (377 * d.batt / 100);
      document.getElementById('cam').src = '/video?' + Date.now();  // refresh video
    });
  </script>
</body>
</html>